# \<harmony/> ビルドガイド

## スイッチ・キーキャップの選定
特殊な幅・刻印のキーキャップを複数使用するため、先に[KLE](https://www.keyboard-layout-editor.com/##@@=%0AEsc&_a:0%3B&=!%0A1%0A%0A%0AF1&=%22%0A2%0A%0A%0AF2&=%23%0A3%0A%0A%0AF3&=$%0A4%0A%0A%0AF4&=%25%0A5%0A%0A%0AF5&=%2F&%0A6%0A%0A%0AF6&='%0A7%0A%0A%0AF7&=(%0A8%0A%0A%0AF8&=)%0A9%0A%0A%0AF9&=%0A0%0A%0A%0AF10&=%2F=%0A-%0A%0A%0AF11&=~%0A%5E%0A%0A%0AF12&=%7C%0A%C2%A5%0A%0A%0AIns&=%0ABS%0A%0A%0ADel%3B&@_w:1.5%3B&=%0ATab%0A%0A%0ACaps&=%0AQ%0A%0A%0AMute&=%0AW%0A%0A%0AEject&_a:4%3B&=%0AE&=%0AR&=%0AT&=%0AY&=%0AU&_a:0%3B&=%0AI%0A%0A%0APSc%0ASRq&=%0AO%0A%0A%0AScrLk&=%0AP%0A%0A%0APus%0ABrk&=%60%0A%2F@%0A%0A%0A%E2%86%91&_a:4%3B&=%7B%0A%5B&_x:0.25&w:1.25&h:2&w2:1.5&h2:1&x2:-0.25%3B&=%0AEnter%3B&@_w:1.75%3B&=%0ACtrl&_a:0%3B&=%0AA%0A%0A%0AVol%20Dn&=%0AS%0A%0A%0AVol%20Up&_a:4%3B&=%0AD&=%0AF%0A%0A%0A%0A%0A%0A%0A%0A%0A%2F_&=%0AG&=%0AH&=%0AJ%0A%0A%0A%0A%0A%0A%0A%0A%0A%2F_&_a:0%3B&=%0AK%0A%0A%0AHome&=%0AL%0A%0A%0APgUp&=%0A%2F%3B+%0A%0A%0A%E2%86%90&=*%0A%2F:%0A%0A%0A%E2%86%92&_a:4%3B&=%7B%0A%5D%3B&@_w:2.25%3B&=%0AShift&=%0AZ&=%0AX&=%0AC&=%0AV&=%0AB&=%0AN&=%0AM&_a:0%3B&=%3C%0A,%0A%0A%0AEnd&=%3E%0A.%0A%0A%0APgDn&=%3F%0A%2F%2F%0A%0A%0A%E2%86%93&_a:4%3B&=%2F_%0A%5C&_w:1.75%3B&=%0AShift%3B&@_x:1%3B&=%0AFn&=%0AAlt&_a:0%3B&=%0A%E5%8D%8A%2F%2F%E5%85%A8%0A%0A%0AGUI&_a:4&w:1.25%3B&=%0A%E7%84%A1%E5%A4%89%E6%8F%9B&_w:1.25%3B&=%0ASpace&_w:1.25%3B&=%0ASpace&_w:1.25%3B&=%0A%E5%A4%89%E6%8F%9B&_a:0%3B&=%0A%E3%82%AB%E3%81%B2%E3%83%AD%0A%0A%0AGUI&_a:4%3B&=%0AAlt&=%0AFn&_x:1&a:0%3B&=%0A%E2%86%91%0A%0A%0APgUp%3B&@_x:12%3B&=%0A%E2%86%90%0A%0A%0AHome&=%0A%E2%86%93%0A%0A%0APgDn&=%0A%E2%86%92%0A%0A%0AEnd)を確認して対応するキーキャップを選定してください。    
本キーボードは「HHKB配列対応」を名乗るキーキャップセットでも完全に対応できない可能性があります。  
必要に応じて無刻印キーキャップの単品や刻印シール、あるいはカスタムキーキャップサービスを使用するなどしてください。  

## 必須パーツの確認
- 基板
- スイッチプレート
- バックパネル
  - 各1枚ずつ、必ず入っています。
- Waveshare RP2040-Zero
  - 1つ必要です。
- スペーサー
  - M2×7mm 六角が6本必要です。M2×3.5mmを4本追加することができます。
- ネジ
  - M2×3mmまたは4mmが12本必要です。3.5mmスペーサーを追加する場合、更にM2×3が6本必要になります。
  - ナベ小ねじなどの頭の径が小さいタイプのものを使用してください。1種ナベネジなど背が低いものだとより良いです。
  - スリムヘッド、低頭などの背が低い代わりに径が大きいものはスイッチと干渉します。
- ダイオード
  - 1N4148シリーズ 表面実装型、リード型どちらでも使用できます。混合も可能です。
  - 69個必要です。
## オプションパーツの確認
- スタビライザー
  - 2uが2個必要です。
- Kailh MX互換ソケット
  - スイッチを交換したい場合に必要になります。
  - North Facingでの実装になります。
  - スイッチをはんだづけする場合は不要です。
  - 69個必要です。
- スルーホールソケット 
  - Mill-Max、Holtite等を想定しています。
  - North FacingでのHotswapに問題がある場合使用します。
  - スイッチをはんだづけする場合は不要です。
  - 必要に合わせて適当数購入してください。
## ファームウェアとソフトの確認
- ファームウェア
  - harmony_test.uf2
    - [firmwareフォルダ](/firmware)にあります。
    - Insecure Mode[^1]でのビルドとなるため、組み立て時の導通チェックとして有用な構成になっています。
    - Windows用キーマップが初期設定されています。
  - harmony_win.uf2
    - test版と同じフォルダにあります。
    - Insecure ModeとBootmagicが無効化[^2]されています。
    - Windows用キーマップが初期設定されています。
  - harmony_mac.uf2
    - test版と同じフォルダにあります。
    - Insecure ModeとBootmagicが無効化[^2]されています。
    - Mac用キーコードを使用したキーマップが初期設定されています。
    - 動作確認は現状行っていません。ご了承ください[^3]
- Vial
  - [Vial公式](https://vial.rocks/)から使用できるマッピングアプリです。
  - [アプリ版](https://get.vial.today/)の方がMatrix Testerの反応が早く、日本語配列にも対応しているのでお勧めです。
  - なくても導通検査ができない&キーマップ書き換えができないだけでなんとかなります。

[^1]:Vialに用意された導通チェッカーやマクロ書き換え時のロックを無効化するモードです。Vial曰くこれは安全ではないらしいので、通常使用の際はtestファームウェアは使用しないことをお勧めします。
[^2]:Bootmagic自体は有効ですが、Bootmagic起動のためのキーは存在しないマトリクス位置に指定しています。事故によるカスタムキーマップ抜けを予防するための措置です。
[^3]:誰かがMac買ってくれたらやります。

## ざっくり組み立て
基板のすべてのパーツを実装します。スタビライザーも実装してください。  
MCUは基板表側にのせ、端子とボタンが使用時下向きになる向きに実装します。  
基板のネジ穴に合わせ、3.5mmスペーサーをねじ止めします。  
スイッチプレートを乗せてスペーサーとねじ止めします。  
この状態でスイッチを実装し、基板の六角形の穴にスペーサーを挿入します。  
スイッチプレート表側からネジ止めします。  
基板裏にバックパネルを乗せ、ネジ止めします。  
バックパネルの隅の四角い表示に合わせ、ゴム足を貼り付けます。

## しっかり組み立て
### ダイオードの実装
基板上の表示に合わせてダイオードを実装します。
### (スイッチはんだづけ時はスキップ)ソケットの実装
基板上の表示に合わせてソケットを実装します。
### MCUの実装
Waveshare RP2040-Zero互換基板は主基板表側に載せます。  
端子とボタンが使用時に下向きになるように一度軽く固定し、MCU基板のエッジスルーホールと主基板のパッドにはんだごてを当ててはんだを送ります。  
パッドがある全てのエッジスルーホールをはんだ付けします。
### (3.5mmスペーサーがある場合のみ)スイッチプレート・基板のねじ止め
基板側にある直径2.2mmの丸穴を探し、スイッチプレートのある方向に3.5mmスペーサーが出るようにねじ止めします。  
スイッチプレートを乗せ、スペーサーとねじ止めすると、基板とスイッチプレートが一体化します。
基板の六角穴に7mmスペーサーを挿入し、スイッチプレートからねじ止めして固定します。
### (3.5mmスペーサーがない場合)スイッチプレートと基板を重ねる
スイッチプレートの端3～4か所程度にスイッチを挿入し、そのまま一旦基板のスルーホールにピンが入るように重ねます。  
基板の六角穴に7mmスペーサーを挿入し、スイッチプレートからねじ止めしてスイッチプレートと基板が軽く固定されるようにします(ネジを回すときにスペーサーが回転しますが、基板に当たって止まります。6か所をねじ止めすると、この状態で軽い固定が成立しています。)。
### (ソケットを実装した場合)スイッチの挿入
スイッチプレートから、ソケットに合うようにスイッチを挿入します。
### (スイッチをはんだ付けする場合)スイッチの実装
スイッチプレートから、スルーホールに合うようにスイッチを挿入し、はんだ付けします。
### バックパネルの実装
基板裏にバックパネルを乗せ、ねじ止めします。
### ゴム足の実装
基板裏の四隅に光を反射させると、薄く正方形が浮かび上がる部分があります。  
ここに合わせてゴム足を貼り付けます。
### スイッチのテスト
Vialを起動し、Matrix Testerからスイッチの導通を見ます。
